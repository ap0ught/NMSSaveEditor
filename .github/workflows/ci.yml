name: Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
    
env:
  # Disable automatic apt updates to prevent ESM repository access
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'temurin'
        # Removed cache: 'maven' since this is not a Maven project
      env:
        # Avoid potential ESM repository access issues
        ACTIONS_ALLOW_UNSECURE_COMMANDS: false
        
    - name: Fallback Java Setup (if network restricted)
      if: failure()
      run: |
        echo "Primary Java setup failed, attempting fallback..."
        # Check if Java is already available from runner pre-installed tools
        if command -v java >/dev/null 2>&1; then
          echo "Java already available from system:"
          java -version
          # Ensure JAVA_HOME is set for any pre-installed Java
          export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "âœ… Using pre-installed Java"
        else
          echo "âŒ No Java available, workflow may fail"
          exit 1
        fi
        
    - name: Verify Java installation
      run: |
        java -version
        javac -version
        
    - name: Check if JAR file exists
      run: |
        if [ -f "NMSSaveEditor.jar" ]; then
          echo "âœ… JAR file found"
          ls -la NMSSaveEditor.jar
        else
          echo "âŒ JAR file not found"
          exit 1
        fi
        
    - name: Test JAR file execution
      run: |
        # Validate JAR file structure and manifest instead of running GUI
        echo "ðŸ” Validating JAR file structure..."
        
        # Check if JAR is a valid zip file
        if unzip -t NMSSaveEditor.jar > /dev/null 2>&1; then
          echo "âœ… JAR file has valid ZIP structure"
        else
          echo "âŒ JAR file has invalid ZIP structure"
          exit 1
        fi
        
        # Check if JAR has a manifest
        if unzip -l NMSSaveEditor.jar | grep -q "META-INF/MANIFEST.MF"; then
          echo "âœ… JAR contains manifest file"
        else
          echo "âŒ JAR missing manifest file"
          exit 1
        fi
        
        # Extract and check manifest for Main-Class
        echo "ðŸ“„ Checking JAR manifest:"
        unzip -p NMSSaveEditor.jar META-INF/MANIFEST.MF | head -10
        
        if unzip -p NMSSaveEditor.jar META-INF/MANIFEST.MF | grep -q "Main-Class:"; then
          echo "âœ… JAR has Main-Class defined in manifest"
        else
          echo "âŒ JAR missing Main-Class in manifest"
          exit 1
        fi
        
        # Test that Java can load the JAR without executing main method
        echo "ðŸ” Testing JAR class loading..."
        if java -Djava.awt.headless=true -cp NMSSaveEditor.jar -version > /dev/null 2>&1; then
          echo "âœ… JAR classes can be loaded by JVM"
        else
          echo "âš ï¸  JAR class loading test skipped (non-critical)"
        fi
        
        echo "âœ… JAR file validation completed successfully"
        
    - name: Verify VERSION.txt
      run: |
        if [ -f "VERSION.txt" ]; then
          echo "âœ… VERSION.txt found"
          echo "Version: $(cat VERSION.txt)"
        else
          echo "âŒ VERSION.txt not found"
          exit 1
        fi
        
    - name: Check documentation files
      run: |
        echo "Checking essential documentation files..."
        
        files=("README.md" "CHANGELOG.md" "FAQ.md")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file missing"
            exit 1
          fi
        done
        
    - name: Validate README links
      run: |
        echo "Checking for broken internal links in README..."
        if grep -q "FAQ.md" README.md; then
          if [ -f "FAQ.md" ]; then
            echo "âœ… FAQ.md link is valid"
          else
            echo "âŒ FAQ.md referenced but file missing"
            exit 1
          fi
        fi
        
    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… JAR file verified" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Documentation complete" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Version file present: $(cat VERSION.txt)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… All checks passed" >> $GITHUB_STEP_SUMMARY